<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DnD Map Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="app-layout">
        <!-- Left Sidebar Panel -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2 class="mdc-typography--headline6">DnD Map Viewer</h2>
                <button id="sidebarToggle" class="toggle-btn">
                    <i class="material-icons">chevron_left</i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Map Selection Section -->
                <div class="control-section">
                    <div class="section-toggle" data-target="map-selection">
                        <i class="material-icons">map</i>
                        <span>Wyb√≥r mapy</span>
                        <i class="material-icons toggle-icon">expand_less</i>
                    </div>
                    <div class="section-content expanded" id="map-selection">
                        <div class="map-select-wrapper">
                            <select id="mapSelect" class="map-select">
                                <option value="">-- Wybierz mapƒô --</option>
                                <option th:each="map : ${maps}" th:value="${map.name}" th:text="${map.name}"></option>
                            </select>
                        </div>

                        <div class="map-actions">
                            <button id="addMapBtn" class="mdc-button mdc-button--outlined map-action-btn">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">add</i>
                                <span class="mdc-button__label">Dodaj mapƒô</span>
                            </button>
                            <button id="deleteMapBtn" class="mdc-button mdc-button--outlined map-action-btn map-action-btn--danger">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">delete</i>
                                <span class="mdc-button__label">Usu≈Ñ mapƒô</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Fog Management Section -->
                <div class="control-section">
                    <div class="section-toggle" data-target="fog-management">
                        <i class="material-icons">cloud</i>
                        <span>ZarzƒÖdzanie mg≈ÇƒÖ</span>
                        <i class="material-icons toggle-icon">expand_less</i>
                    </div>
                    <div class="section-content expanded" id="fog-management">
                        <div class="fog-controls">
                            <button id="eraseFogBtn" class="mdc-button mdc-button--outlined fog-btn">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">cleaning_services</i>
                                <span class="mdc-button__label">Usu≈Ñ mg≈Çƒô</span>
                            </button>
                        </div>

                        <div class="fog-controls">
                            <button id="paintFogBtn" class="mdc-button mdc-button--outlined fog-btn">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">brush</i>
                                <span class="mdc-button__label">Maluj mg≈Çƒô</span>
                            </button>
                        </div>

                        <div class="fog-controls">
                            <button id="resetFogBtn" class="mdc-button mdc-button--outlined fog-btn fog-btn--danger">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">restart_alt</i>
                                <span class="mdc-button__label">Reset mg≈Çy</span>
                            </button>
                        </div>

                        <div class="grid-area-control">
                            <label for="gridAreaSize">Obszar kratek:</label>
                            <select id="gridAreaSize" class="grid-area-select">
                                <option value="1">1x1</option>
                                <option value="2">2x2</option>
                                <option value="3" selected>3x3</option>
                            </select>
                        </div>

                    </div>
                </div>

                <!-- Characters Section -->
                <div class="control-section">
                    <div class="section-toggle collapsed" data-target="characters-management">
                        <i class="material-icons">people</i>
                        <span>Postacie</span>
                        <i class="material-icons toggle-icon">expand_more</i>
                    </div>
                    <div class="section-content" id="characters-management">
                        <div class="character-info">
                            <p class="info-text">
                                <i class="material-icons info-icon">info</i>
                                Kliknij przycisk, nastƒôpnie kliknij na kratkƒô. SHIFT+przeciƒÖgnij aby przenie≈õƒá postaƒá.
                            </p>
                        </div>
                        <div class="character-mode-controls">
                            <button id="addPlayerBtn" class="mdc-button mdc-button--outlined character-btn">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">person</i>
                                <span class="mdc-button__label">Dodaj gracza</span>
                            </button>
                            <button id="addEnemyBtn" class="mdc-button mdc-button--outlined character-btn">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">dangerous</i>
                                <span class="mdc-button__label">Dodaj wroga</span>
                            </button>
                            <button id="moveCharacterBtn" class="mdc-button mdc-button--outlined character-btn">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">drag_indicator</i>
                                <span class="mdc-button__label">Przesu≈Ñ postaƒá</span>
                            </button>
                            <button id="removeCharacterBtn" class="mdc-button mdc-button--outlined character-btn character-btn--danger">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">delete</i>
                                <span class="mdc-button__label">Usu≈Ñ postaƒá</span>
                            </button>
                        </div>

                        <div class="character-delete-controls">
                            <button id="removeLastPlayerBtn" class="mdc-button mdc-button--outlined character-btn-small">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">person_remove</i>
                                <span class="mdc-button__label">Usu≈Ñ ostatniego gracza</span>
                            </button>
                            <button id="removeAllPlayersBtn" class="mdc-button mdc-button--outlined character-btn-small character-btn--danger">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">group_remove</i>
                                <span class="mdc-button__label">Usu≈Ñ graczy</span>
                            </button>
                            <button id="removeLastEnemyBtn" class="mdc-button mdc-button--outlined character-btn-small">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">remove_circle</i>
                                <span class="mdc-button__label">Usu≈Ñ ostatniego wroga</span>
                            </button>
                            <button id="removeAllEnemiesBtn" class="mdc-button mdc-button--outlined character-btn-small character-btn--danger">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">clear_all</i>
                                <span class="mdc-button__label">Usu≈Ñ wrog√≥w</span>
                            </button>
                        </div>

                    </div>
                </div>

                <!-- View Section -->
                <div class="control-section">
                    <div class="section-toggle" data-target="view-settings">
                        <i class="material-icons">visibility</i>
                        <span>Widok</span>
                        <i class="material-icons toggle-icon">expand_more</i>
                    </div>
                    <div class="section-content" id="view-settings">
                        <div class="view-controls">
                            <button id="toggleGridBtn" class="mdc-button mdc-button--outlined">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">grid_on</i>
                                <span class="mdc-button__label">Poka≈º/Ukryj siatka</span>
                            </button>
                        </div>

                        <div class="rotation-control">
                            <label>Obr√≥t mapy:</label>
                            <div class="rotation-buttons">
                                <button id="rotateLeftBtn" class="mdc-button mdc-button--outlined rotation-btn">
                                    <span class="mdc-button__ripple"></span>
                                    <i class="material-icons mdc-button__icon">rotate_left</i>
                                    <span class="mdc-button__label">-90¬∞</span>
                                </button>
                                <span id="rotationValue" class="rotation-value">0¬∞</span>
                                <button id="rotateRightBtn" class="mdc-button mdc-button--outlined rotation-btn">
                                    <span class="mdc-button__ripple"></span>
                                    <i class="material-icons mdc-button__icon">rotate_right</i>
                                    <span class="mdc-button__label">+90¬∞</span>
                                </button>
                            </div>
                            <button id="resetRotationBtn" class="mdc-button mdc-button--outlined">
                                <span class="mdc-button__ripple"></span>
                                <i class="material-icons mdc-button__icon">restart_alt</i>
                                <span class="mdc-button__label">Reset obrotu</span>
                            </button>
                        </div>

                        <div class="grid-color-controls">
                            <div class="color-control">
                                <label for="gridColorPicker">Kolor siatki:</label>
                                <input type="color" id="gridColorPicker" value="#ffffff" class="color-picker">
                            </div>
                        </div>

                        <div class="fog-color-controls">
                            <div class="color-control">
                                <label for="fogColorPickerView">Kolor mg≈Çy:</label>
                                <input type="color" id="fogColorPickerView" value="#808080" class="color-picker">
                            </div>
                            <div class="color-control">
                                <label for="fogOpacitySlider">Przezroczysto≈õƒá mg≈Çy: <span id="fogOpacityValue">65%</span></label>
                                <input type="range" id="fogOpacitySlider" min="0" max="1" value="0.65" class="opacity-slider">
                            </div>
                        </div>

                        <div class="character-color-controls">
                            <div class="color-control">
                                <label for="playerColorPicker">Kolor gracza:</label>
                                <input type="color" id="playerColorPicker" value="#00ff00" class="color-picker">
                            </div>
                            <div class="color-control">
                                <label for="enemyColorPicker">Kolor wroga:</label>
                                <input type="color" id="enemyColorPicker" value="#ff0000" class="color-picker">
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Grid Calibration Section -->
                <div class="control-section">
                    <div class="section-toggle" data-target="grid-calibration">
                        <i class="material-icons">grid_on</i>
                        <span>Konfiguracja siatki</span>
                        <i class="material-icons toggle-icon">expand_more</i>
                    </div>
                    <div class="section-content" id="grid-calibration">
                        <div class="status-chip">
                            <span id="gridStatus" class="mdc-typography--caption">Siatka: brak</span>
                        </div>

                        <div class="grid-manual">
                            <h4 style="margin: 0 0 12px 0; font-size: 0.85rem; color: var(--text-secondary);">Automatyczne wyliczanie:</h4>
                            <div class="manual-inputs">
                                <div class="input-wrapper">
                                    <label for="gridCountXInput">Kratek X:</label>
                                    <input type="number" id="gridCountXInput" min="1" step="1" placeholder="np. 20" />
                                </div>
                                <div class="input-wrapper">
                                    <label for="gridCountYInput">Kratek Y:</label>
                                    <input type="number" id="gridCountYInput" min="1" step="1" placeholder="np. 15" />
                                </div>
                            </div>

                            <h4 style="margin: 16px 0 12px 0; font-size: 0.85rem; color: var(--text-secondary);">Rƒôczna konfiguracja:</h4>
                            <div class="manual-inputs">
                                <div class="input-wrapper">
                                    <label for="gridSizeInput">Rozmiar kratki:</label>
                                    <input type="number" id="gridSizeInput" min="1" step="0.1" placeholder="px" />
                                </div>
                                <div class="input-wrapper">
                                    <label for="gridOffsetXInput">Offset X:</label>
                                    <input type="number" id="gridOffsetXInput" step="0.1" placeholder="px" />
                                </div>
                                <div class="input-wrapper">
                                    <label for="gridOffsetYInput">Offset Y:</label>
                                    <input type="number" id="gridOffsetYInput" step="0.1" placeholder="px" />
                                </div>
                                <div class="input-wrapper">
                                    <label for="gridLineWidthInput">Grubo≈õƒá linii:</label>
                                    <input type="number" id="gridLineWidthInput" step="0.1" min="0.1" max="10" value="1" />
                                </div>
                            </div>
                            <div class="manual-actions">
                                <button id="saveGridBtn" class="mdc-button mdc-button--raised">
                                    <span class="mdc-button__ripple"></span>
                                    <i class="material-icons mdc-button__icon">save</i>
                                    <span class="mdc-button__label">Zapisz</span>
                                </button>
                                <button id="clearGridBtn" class="mdc-button mdc-button--outlined manual-btn--danger">
                                    <span class="mdc-button__ripple"></span>
                                    <i class="material-icons mdc-button__icon">delete</i>
                                    <span class="mdc-button__label">Usu≈Ñ</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Control - przeniesione pod Konfiguracjƒô siatki -->
                    <div class="preview-control-section">
                        <button id="setPreviewMapBtn" class="mdc-button mdc-button--outlined preview-btn">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon">visibility</i>
                            <span class="mdc-button__label">Wczytaj podglƒÖd</span>
                        </button>
                    </div>
                </div>
                <!-- Preview Control at Bottom -->
                <div class="sidebar-footer">

                    <!-- Version Info -->
                    <div class="version-info">
                        <div class="version-compact">
                            <span id="appVersion" class="version-value">1.20</span> ‚Ä¢ <span id="buildDate" class="version-value">2025-11-18 16:29</span>
                        </div>
                    </div>
                </div>
            </div>



        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="left-controls">
                <div class="navigation-controls">
                    <div class="nav-row"><button id="navUpBtn" class="nav-btn" title="PodglƒÖd - g√≥ra">‚ñ≤</button></div>
                    <div class="nav-row">
                        <button id="navLeftBtn" class="nav-btn" title="PodglƒÖd - lewo">‚óÄ</button>
                        <button id="navCenterBtn" class="nav-btn" title="Wycentruj podglƒÖd">‚ö´</button>
                        <button id="navRightBtn" class="nav-btn" title="PodglƒÖd - prawo">‚ñ∂</button>
                    </div>
                    <div class="nav-row"><button id="navDownBtn" class="nav-btn" title="PodglƒÖd - d√≥≈Ç">‚ñº</button></div>
                </div>
                <div class="zoom-controls">
                    <div class="zoom-input-row">
                        <input type="number" id="zoomLevel" class="zoom-input" min="10" max="500" step="5" value="100" title="Zoom podglƒÖdu %" />
                        <span class="zoom-unit">%</span>
                        <button id="rotatePreviewLeftBtn" class="zoom-precise-btn" title="Obr√≥ƒá mapƒô o -90¬∞">‚Ü∂</button>
                        <button id="rotatePreviewBtn" class="zoom-precise-btn" title="Obr√≥ƒá mapƒô o +90¬∞">‚Ü∑</button>
                    </div>
                </div>
            </div>
            <div class="map-container" id="mapContainer">
                <div class="map-wrapper" id="mapWrapper">
                    <img id="mapImage" class="map-image hidden" alt="Mapa DnD">
                    <canvas id="gridCanvas" class="fog-layer hidden"></canvas>
                    <canvas id="fogCanvas" class="fog-layer hidden"></canvas>
                    <canvas id="calibrationCanvas" class="fog-layer hidden"></canvas>
                    <canvas id="viewportOverlayCanvas" class="fog-layer hidden"></canvas>
                    <canvas id="charactersCanvas" class="fog-layer hidden"></canvas>
                </div>

                <!-- Kontrolki zoom GM w prawym dolnym rogu -->
                <div class="precise-zoom-controls">
                    <div class="zoom-title">Zoom GM</div>
                    <div class="zoom-input-row">
                        <button id="zoomDecrease1Btn" class="zoom-precise-btn" title="Zmniejsz mapƒô GM">-</button>
                        <input type="number" id="zoomInput" class="zoom-input" min="10" max="500" step="1" value="100" title="Zoom mapy GM %" />
                        <span class="zoom-unit">%</span>
                        <button id="zoomIncrease1Btn" class="zoom-precise-btn" title="Zwiƒôksz mapƒô GM">+</button>
                    </div>
                    <div class="zoom-presets">
                        <button id="zoom50Btn" class="zoom-preset-btn">50%</button>
                        <button id="zoom100Btn" class="zoom-preset-btn">100%</button>
                        <button id="zoom150Btn" class="zoom-preset-btn">150%</button>
                        <button id="zoom200Btn" class="zoom-preset-btn">200%</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modular JavaScript files -->
    <script src="/js/ui.js"></script>
    <script src="/js/input.js"></script>
    <script src="/js/grid.js"></script>
    <script src="/js/fog.js"></script>
    <script src="/js/characters.js"></script>
    <script src="/js/viewport.js"></script>
    <script>
        // TYMCZASOWE DEBUGOWANIE VIEWPORTMANAGER
        console.log('üîç IMMEDIATE CHECK after viewport.js load:');
        console.log('   ViewportManager available:', typeof ViewportManager);
        console.log('   window.ViewportManager available:', typeof window.ViewportManager);
        setTimeout(() => {
            console.log('üîç DELAYED CHECK (100ms after):');
            console.log('   ViewportManager available:', typeof ViewportManager);
            console.log('   window.ViewportManager available:', typeof window.ViewportManager);
        }, 100);
    </script>
    <script src="/js/app-modular.js"></script>
</body>
</html>
